var Game=pc.createScript("game");Game.attributes.add("uiMenu",{type:"entity"}),Game.attributes.add("uiInGame",{type:"entity"}),Game.attributes.add("uiGameOver",{type:"entity"}),Game.attributes.add("audio",{type:"entity"}),Game.STATE_MENU="menu",Game.STATE_INGAME="ingame",Game.STATE_GAMEOVER="gameover",Game.prototype.initialize=function(){this._state=Game.STATE_MENU,this._score=0,this.setResolution(),window.addEventListener("resize",this.setResolution.bind(this)),this.app.on("ui:start",this.start,this),this.app.on("ui:reset",this.reset,this)},Game.prototype.setResolution=function(){var e=window.screen.width,t=window.screen.height;e<640&&(this.app.setCanvasResolution(pc.RESOLUTION_AUTO,e,t),this.app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW))},Game.prototype.start=function(){this._state=Game.STATE_INGAME,this.app.fire("game:start"),this.uiMenu.enabled=!1,this.uiInGame.enabled=!0,this.audio.sound.play("music")},Game.prototype.gameOver=function(){this._state=Game.STATE_GAMEOVER,this.app.fire("game:gameover"),this.uiInGame.enabled=!1,this.uiGameOver.enabled=!0,this.app.fire("game:score",this._score),this.audio.sound.stop(),this.audio.sound.play("gameover")},Game.prototype.reset=function(){this.app.fire("game:reset"),this.resetScore(),this._state=Game.STATE_MENU,this.uiGameOver.enabled=!1,this.uiMenu.enabled=!0,this.audio.sound.stop()},Game.prototype.getScore=function(){return this._score},Game.prototype.addScore=function(e){this._score+=e,this.app.fire("game:score",this._score)},Game.prototype.resetScore=function(){this._score=0,this.app.fire("game:score",this._score)};var UiScore=pc.createScript("uiScore");UiScore.prototype.initialize=function(){this.score=this.entity.findByName("Score"),this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onEnable()},UiScore.prototype.onEnable=function(){this.app.on("game:score",this._changeScore,this),this._changeScore(0)},UiScore.prototype.onDisable=function(){this.app.off("game:score",this._changeScore,this)},UiScore.prototype._changeScore=function(e){this.score.element.text=e.toString()};var UiGameover=pc.createScript("uiGameover");UiGameover.attributes.add("overlay",{type:"entity"}),UiGameover.prototype.initialize=function(){this.score=this.entity.findByName("Score"),this._score=0,this.app.on("game:score",(function(e){this._score=e,this.score.element.text=this._score.toString()}),this),this.onEnable(),this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this)},UiGameover.prototype.onEnable=function(){this.overlay.enabled=!0,this.overlay.element.on("click",this.reset,this)},UiGameover.prototype.onDisable=function(){this.overlay.enabled=!1,this.overlay.element.off("click",this.reset,this)},UiGameover.prototype.reset=function(e){this.app.fire("ui:reset"),e.stopPropagation()};var UiMenu=pc.createScript("uiMenu");UiMenu.attributes.add("overlay",{type:"entity"}),UiMenu.prototype.initialize=function(){this.on("enable",this.onEnable,this),this.on("disable",this.onDisable,this),this.onEnable()},UiMenu.prototype.onEnable=function(){this.overlay.enabled=!0,this.overlay.element.on("click",this.start,this),this.ball&&(this.ball.model.meshInstances[0].material.depthTest=!1)},UiMenu.prototype.onDisable=function(){this.overlay.enabled=!1,this.overlay.element.off("click",this.start,this)},UiMenu.prototype.start=function(t){this.app.fire("ui:start"),t.stopPropagation()};var Input=pc.createScript("input");Input.attributes.add("ball",{type:"entity"}),Input.attributes.add("camera",{type:"entity"}),Input.attributes.add("ballRadius",{type:"number",default:.5}),Input.worldPos=new pc.Vec3,Input.prototype.initialize=function(){var t=this;this._paused=!0,this.app.on("game:start",(function(){t._paused=!1})),this.app.on("game:gameover",(function(){t._paused=!0})),this.app.touch&&this.app.touch.on("touchstart",this._onTouchStart,this),this.app.mouse.on("mousedown",this._onMouseDown,this)},Input.prototype._onTap=function(t,a){var o=this.ball.getPosition(),n=this.camera.getPosition(),e=Input.worldPos;this.camera.camera.screenToWorld(t,a,n.z-o.z,e);var i=o.x-e.x,p=o.y-e.y;i*i+p*p<this.ballRadius*this.ballRadius&&this.ball.script.ball.tap(i,p)},Input.prototype._onTouchStart=function(t){if(!this._paused){var a=t.changedTouches[0];this._onTap(a.x,a.y),t.event.preventDefault()}},Input.prototype._onMouseDown=function(t){this._paused||this._onTap(t.x,t.y)};var Ball=pc.createScript("ball");Ball.attributes.add("gravity",{type:"number",default:-9.8,description:"The value of gravity to use"}),Ball.attributes.add("defaultTap",{type:"number",default:5,description:"Speed to set the ball to when it is tapped"}),Ball.attributes.add("impactEffect",{type:"entity",description:"The particle effect to trigger when the ball is tapped"}),Ball.attributes.add("ballMinimum",{type:"number",default:-6,description:"When ball goes below minimum y value game over is triggered"}),Ball.attributes.add("speedMult",{type:"number",default:4,description:"Multiplier to apply to X speed when tap is off center"}),Ball.attributes.add("angMult",{type:"number",default:-6,description:"Multiplier to apply to angular speed when tap is off center"}),Ball.tmp=new pc.Vec3,Ball.prototype.initialize=function(){this.paused=!0,this.game=this.app.root.findByName("Game"),this.app.on("game:start",this.unpause,this),this.app.on("game:gameover",this.pause,this),this.app.on("game:reset",this.reset,this),this._vel=new pc.Vec3(0,0,0),this._acc=new pc.Vec3(0,this.gravity,0),this._angSpeed=0,this._origin=this.entity.getLocalPosition().clone(),this._rotation=this.entity.getLocalRotation().clone()},Ball.prototype.update=function(t){if(this.paused)this.entity.rotate(0,30*t,0);else{var e=this.entity.getLocalPosition(),i=Ball.tmp;i.copy(this._acc).scale(t),this._vel.add(i),i.copy(this._vel).scale(t),e.add(i),this.entity.setLocalPosition(e),this.entity.rotate(0,0,this._angSpeed),e.y<this.ballMinimum&&this.game.script.game.gameOver()}},Ball.prototype.tap=function(t,e,i){this._vel.set(this.speedMult*t,this.defaultTap,0),this._angSpeed+=this.angMult*t;var a=Ball.tmp;a.copy(this.entity.getLocalPosition()),a.x-=t,a.y-=e,this.impactEffect.setLocalPosition(a),this.impactEffect.particlesystem.reset(),this.impactEffect.particlesystem.play(),this.impactEffect.lookAt(this.entity.getPosition()),this.entity.sound.play("bounce"),i||this.game.script.game.addScore(1)},Ball.prototype.unpause=function(){this.paused=!1,this.tap(0,0,!0)},Ball.prototype.pause=function(){this.paused=!0},Ball.prototype.reset=function(){this.entity.setLocalPosition(this._origin),this.entity.setLocalRotation(this._rotation),this._vel.set(0,0,0),this._acc.set(0,this.gravity,0),this._angSpeed=0};